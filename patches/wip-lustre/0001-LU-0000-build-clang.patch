From 6614ec9e4408eb2d2a5ad9064869398e876ec133 Mon Sep 17 00:00:00 2001
From: Tim Day <tday141@gmail.com>
Date: Tue, 14 Feb 2023 06:40:12 +0000
Subject: [PATCH] LU-0000 build: clang

Fix autoconf issues

Signed-off-by: Timothy Day <timday@amazon.com>
---
 config/lustre-build-ldiskfs.m4 | 2 +-
 config/lustre-build-linux.m4   | 8 ++++----
 config/lustre-build.m4         | 4 ++--
 lustre/autoconf/lustre-core.m4 | 4 ++--
 4 files changed, 9 insertions(+), 9 deletions(-)

diff --git a/config/lustre-build-ldiskfs.m4 b/config/lustre-build-ldiskfs.m4
index b24493bf5e..329f2acf93 100644
--- a/config/lustre-build-ldiskfs.m4
+++ b/config/lustre-build-ldiskfs.m4
@@ -517,7 +517,7 @@ AC_DEFUN([LB_JBD2_JOURNAL_GET_MAX_TXN_BUFS], [
 #
 AC_DEFUN([LB_EXT4_JOURNAL_GET_WRITE_ACCESS_4A], [
 tmp_flags="$EXTRA_KCFLAGS"
-EXTRA_KCFLAGS="-Werror"
+EXTRA_KCFLAGS="-Wno-error"
 LB_CHECK_COMPILE([if jbd2_journal_get_max_txn_bufs is available],
 ext4_journal_get_write_access, [
 	#include <linux/fs.h>
diff --git a/config/lustre-build-linux.m4 b/config/lustre-build-linux.m4
index 63e212a3d1..b87478df66 100644
--- a/config/lustre-build-linux.m4
+++ b/config/lustre-build-linux.m4
@@ -418,7 +418,7 @@ LB_LINUX_VERSION
 
 # --- Parallel config for kernel v5.17+
 AS_IF([test "x$lb_cv_dequote_CC_VERSION_TEXT" = "xyes"], [
-	CC_VERSION_TEXT=$(gcc --version | head -n1 | tr ' ()' '.')
+	CC_VERSION_TEXT=$($CC --version | head -n1 | tr ' ()' '.')
 	MAKE_KMOD_ENV="CONFIG_CC_VERSION_TEXT='$CC_VERSION_TEXT'"])
 
 # --- check that we can build modules at all
@@ -838,10 +838,10 @@ AC_DEFUN([LB2_LINUX_TEST_COMPILE], [
 	J=${TEST_JOBS:-$(nproc)}
 
 	AC_MSG_NOTICE([Making $1 in $D])
-	AC_MSG_NOTICE([KBUILD_MODPOST_NOFINAL="yes" make modules -k -j${J} -C $LINUX_OBJ $ARCH_UM M=${D} $MAKE_KMOD_ENV])
+	AC_MSG_NOTICE([KBUILD_MODPOST_NOFINAL="yes" make modules CC=$CC -k -j${J} -C $LINUX_OBJ $ARCH_UM M=${D} $MAKE_KMOD_ENV])
 
 	AC_TRY_COMMAND([KBUILD_MODPOST_NOFINAL="yes"
-		make modules -k -j${J} -C $LINUX_OBJ $ARCH_UM M=${D} $MAKE_KMOD_ENV >${L} 2>&1])
+		make modules CC=$CC -k -j${J} -C $LINUX_OBJ $ARCH_UM M=${D} $MAKE_KMOD_ENV >${L} 2>&1])
 	AS_IF([test -f ${L}],
 	      [AS_IF([test -f $2/Makefile],
 		     [mv $2/Makefile $2/Makefile.compile.$1])],
@@ -924,7 +924,7 @@ AC_DEFUN([LB2_LINUX_TEST_RESULT],[
 			for mf in $(ls -1 ${TEST_DIR}/Makefile.compile.*); do
 				ln -sf $mf ${D}/Makefile
 				KBUILD_MODPOST_NOFINAL="yes"
-				make modules -k -j${J} -C $LINUX_OBJ $ARCH_UM M=${D} >> rebuild.log 2>&1
+				make modules CC=$CC -k -j${J} -C $LINUX_OBJ $ARCH_UM M=${D} >> rebuild.log 2>&1
 
 				for dir in $(awk '/^obj-m/ { print [$]3 }' ${D}/$mf); do
 					name=${dir%/}
diff --git a/config/lustre-build.m4 b/config/lustre-build.m4
index 93a46932d5..1d84de1ec2 100644
--- a/config/lustre-build.m4
+++ b/config/lustre-build.m4
@@ -380,7 +380,7 @@ AC_DEFUN([LB_CC_NO_FORMAT_TRUNCATION], [
 	AC_MSG_CHECKING([for -Wno-format-truncation support])
 
 	saved_flags="$CFLAGS"
-	CFLAGS="$CFLAGS -Wno-format-truncation"
+	CFLAGS="$CFLAGS -Werror -Wno-format-truncation"
 
 	AC_COMPILE_IFELSE([AC_LANG_PROGRAM([], [])], [
 		EXTRA_KCFLAGS="$EXTRA_KCFLAGS -Wno-format-truncation"
@@ -424,7 +424,7 @@ AC_DEFUN([LB_CC_NO_STRINGOP_OVERFLOW], [
 	AC_MSG_CHECKING([for -Wno-stringop-overflow support])
 
 	saved_flags="$CFLAGS"
-	CFLAGS="$CFLAGS -Wno-stringop-overflow"
+	CFLAGS="$CFLAGS -Werror -Wno-stringop-overflow"
 
 	AC_COMPILE_IFELSE([AC_LANG_PROGRAM([], [])], [
 		EXTRA_KCFLAGS="$EXTRA_KCFLAGS -Wno-stringop-overflow"
diff --git a/lustre/autoconf/lustre-core.m4 b/lustre/autoconf/lustre-core.m4
index 0f7307242e..2c5672fee1 100644
--- a/lustre/autoconf/lustre-core.m4
+++ b/lustre/autoconf/lustre-core.m4
@@ -3800,8 +3800,8 @@ AC_DEFUN([LC_CONFIGURE], [
 AC_MSG_NOTICE([Lustre core checks
 ==============================================================================])
 
-AS_IF([test $target_cpu == "i686" -o $target_cpu == "x86_64"],
-	[CFLAGS="$CFLAGS -Wall -Werror"])
+#AS_IF([test $target_cpu == "i686" -o $target_cpu == "x86_64"],
+#	[CFLAGS="$CFLAGS -Wall -Werror"])
 
 # maximum MDS thread count
 LC_MDS_MAX_THREADS
-- 
2.27.0

